{% load staticfiles%}
<div class="well well-sm">
  <div class="row">
    <div class="col-sm-10">
      <div class="row">
        <div class="col-sm-12" id="rank-yearrange">
        </div>
        <div class="col-sm-12" id="rank-conflist">
        </div>
      </div>
    </div>
    <div class="col-sm-2">
      <button class="btn btn-primary" id="rankbutton">Rank</button>
    </div>
  </div>
</div>
<table id="rtable" class="table table-condensed table-hover" cellspacing="0" width="100%">
  <thead>
    <tr>
      <th></th>
      <th>Rank</th>
      <th>Institution</th>
      <th>Papers</th>
      <th>Citations</th>
      <th>Combined</th>
    </tr>
  </thead>
  <tbody id="rtablebody">
    {% for ent in data %}
    <tr>
      <td class="details-control"></td>
      <td class="index"></td>
      <td>{{ ent.0 }}</td>
      <td>{{ ent.1|floatformat }}</td>
      <td>{{ ent.2|floatformat }}</td>
      <td>{{ ent.3|floatformat }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script type="text/javascript">
$('#rankbutton').click(function(e) {
  $.ajax({
    type: "POST",
    url: "/update",
    async: false,
    data: {
      syear: nodes[0].innerHTML,
      eyear: nodes[1].innerHTML,
      conflist: document.getElementById("rank-conflist").innerText
    },
    success: function (result) {
      console.log("Rank success");
      console.log(result);
      var tablebody = document.getElementById("rtablebody");
      $("#rtablebody tr").remove();
      for(var i in result) {
        var row = tablebody.insertRow(i);
        row.insertCell(0).setAttribute("class", "details-control");
        row.insertCell(1).setAttribute("class", "index");
        row.insertCell(2).innerHTML = result[i][0];
        row.insertCell(3).innerHTML = result[i][1].toFixed(1);
        row.insertCell(4).innerHTML = result[i][2].toFixed(1);
        row.insertCell(5).innerHTML = result[i][3].toFixed(1);
      }
    }
  });
});

var table = $('#rtable').DataTable({
  "dom":  "<'row'<'col-sm-6'l><'col-sm-6'<'alphaslider'>>>" +
          "<'row'<'col-sm-12'tr>>" +
          "<'row'<'col-sm-4'i><'col-sm-8'p>>",
  "pageLength": 20,
  "lengthMenu": [ 10, 20, 50, 100 ],
  "lengthChange": true,
  "columnDefs": [ {
      "targets": [0, 1],
      "orderable": false
  },{
      "targets": 1,
      "sortable": false
  }],
  "fixedColumns": true,
  "paging": true,
  "pagingType": "simple_numbers",
  "searching": false,
  "ordering": true,
  "order": [[ 5, "desc" ]],
  "info": true,
  "autoWidth": false
});

$("div.alphaslider").html(
  '<div class="range">'+
    '<input type="range" min="0" max="10" value="5" onchange="changeValue(this.value)"/>'+
    '<output>&alpha; = <span class="text-primary" id="alphaValue">0.5</span></output>'+
  '</div>'+
  '<small class="text-muted">Combined = &alpha;*papers + (1-&alpha;)*citations</small>'
);

table.on( 'order.dt search.dt', function () {
  table.column(1, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
    cell.innerHTML = i+1;
  } );
} ).draw();

function updateTable(alpha){
  table.rows().eq(0).each( function (index) {
    var row = table.row(index);
    var data = row.data();
    combined = alpha*parseFloat(data[3]) + (1-alpha)*parseFloat(data[4]);
    data[5] = Number((combined).toFixed(1));
    table.row(index).data(data);
  });
  table.draw();
}
updateTable(0.5);
updateInfo();

function changeValue(newValue) {
    document.getElementById("alphaValue").innerHTML = newValue/10;
    updateTable(newValue/10);
};

function format (d) {
    // `d` is the original data object for the row
    return '<table cellpadding="5" cellspacing="0" border="0" style="font-size:14px; padding-left:50px;">'+
        '<tr>'+
            '<td>More info: </td>'+
            '<td>'+d+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>More info: </td>'+
            '<td>blahblah</td>'+
        '</tr>'+
    '</table>';
}

$('#rtable tbody').on('click', 'td.details-control', function () {
    var tr = $(this).closest('tr');
    var row = table.row( tr );
    if ( row.child.isShown() ) {
        row.child.hide();
        tr.removeClass('shown');
    } else {
        row.child(format(row.data()[2])).show();
        tr.addClass('shown');
    }
} );
</script>
