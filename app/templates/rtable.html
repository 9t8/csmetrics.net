{% load staticfiles%}
<div class="well well-sm">
  <div class="row">
    <div class="col-sm-5">
      <div>{{ words.forward_info }}: <span id="rank-pub-range"></span></div>
      <div>{{ words.backward_info }}: <span id="rank-cit-range"></span></div>
    </div>
    <div class="col-sm-5">
      Weight Metric: <span id="weight-metric" class="text-uppercase">Not Selected</span>
    </div>
    <div class="col-sm-2">
      <button class="btn btn-success" style="width:100%;" id="rankbutton">{{ words.rank_button }}</button>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-12" id="rank-conflist">
    </div>
  </div>
</div>
<div id="spinner" class="invisible">
  <i class="fa fa-spinner fa-spin" style="font-size:80px"></i>
</div>
<table id="rtable" class="row-border hover order-column" cellspacing="0" width="100%">
</table>
<script type="text/javascript">
var spinner = document.getElementById("spinner");
var table = $('#rtable').DataTable({
  "dom":  "<'row'<'col-sm-6'l><'col-sm-6'<'alphaslider'>>>" +
          "<'row'<'col-sm-12'tr>>" +
          "<'row'<'col-sm-4'i><'col-sm-8'p>>",
  "pageLength": 20,
  "lengthMenu": [ 10, 20, 50, 100 ],
  "lengthChange": true,
  "columns": [
    // { className: "details-control" },
    { title: "{{ words.rtable_label_0 }}", className: "index dt-body-center" },
    { title: "{{ words.rtable_label_1 }}", className: "dt-body-left" },
    { title: "{{ words.rtable_label_2 }}", className: "dt-body-right" },
    { title: "{{ words.rtable_label_3 }}", className: "dt-body-right" },
    { title: "{{ words.rtable_label_4 }}", className: "dt-body-right" },
    { title: "{{ words.rtable_label_5 }}", className: "dt-body-right" },
    { title: "{{ words.rtable_label_6 }}", className: "dt-body-right" }
  ],
  "columnDefs": [
    // {
    //   "targets": [0, 1],
    //   "orderable": false
    // },
    {
      "targets": 0,
      "sortable": false,
      "orderable": false
    }
  ],
  "fixedColumns": true,
  "paging": true,
  "pagingType": "simple_numbers",
  "searching": false,
  "ordering": true,
  // "order": [[ 7, "desc" ]],
  "order": [[ 6, "desc" ]],
  "info": true,
  "autoWidth": false,
  "sortClasses": true
});

$("div.alphaslider").html(
  '<div class="range">'+
    '<input type="range" min="0" max="10" value="5" onchange="changeValue(this.value)"/>'+
    '<output>&alpha; = <span class="text-primary" id="alphaValue">0.5</span></output>'+
  '</div>'+
  '<div class="text-center"><small id="alphaslider-text" class="text-muted"></small></div>'
);

// update rank index
table.on( 'order.dt search.dt', function () {
  table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
    cell.innerHTML = i+1;
  } );
} ).draw();

$('#rankbutton').click(function(e) {
  spinner.classList.remove("invisible");
  $.ajax({
    type: "POST",
    url: "/update",
    data: {
      pub_syear: nodes[0].innerHTML,
      pub_eyear: nodes[1].innerHTML,
      cit_syear: nodes[2].innerHTML,
      cit_eyear: nodes[3].innerHTML,
      weight: document.getElementById("weight-metric").innerText,
      conflist: document.getElementById("rank-conflist").innerText
    },
    success: function (result) {
      // console.log("Rank success");
      table.clear();
      for(var i in result) {
        // console.log(result[i]);
        // result[0]: institution name
        // result[1]: paper count
        // result[2]: w. paper count
        // result[3]: citation count
        // result[4]: w. citation count
        // result[5]: 0 -- will be calculated later
        var newRow = {};
        // newRow[0] = null;
        newRow[0] = null;
        newRow[1] = result[i][0];
        newRow[2] = result[i][3].toFixed(0);
        newRow[3] = result[i][4].toFixed(0);
        newRow[4] = result[i][1].toFixed(0);
        newRow[5] = result[i][2].toFixed(0);
        newRow[6] = result[i][5].toFixed(0);
        table.row.add(newRow);
      }
      updateTable();
      spinner.classList.add("invisible");
    }
  });
});

function updateTable(){
  // console.log("updateTable");
  var alpha = document.getElementById("alphaValue").innerText;
  var alphatext = document.getElementById("alphaslider-text");
  table.rows().eq(0).each( function (index) {
    var row = table.row(index);
    var data = row.data();
    combined = Math.pow(parseFloat(data[3]), 1-alpha)
              *Math.pow(parseFloat(data[5]), alpha);
    data[6] = Number((combined).toFixed(0));
    table.row(index).data(data);
  });

  console.log(weightselector.value);
  if (weightselector.value == "equal") {
    table.column(3).visible(false);
    table.column(5).visible(false);
    alphatext.innerHTML = "Combined = Measured<sup>&alpha;</sup> x Estimated<sup>1-&alpha;</sup>";
  } else {
    table.column(3).visible(true);
    table.column(5).visible(true);
    alphatext.innerHTML = "Combined = w.Measured<sup>1-&alpha;</sup> x w.Estimated<sup>&alpha;</sup>";
  }
  table.draw();
}
updateInfoYear();

function changeValue(newValue) {
    document.getElementById("alphaValue").innerHTML = newValue/10;
    updateTable(newValue/10);
};


// more option - disabled for now
function format (d) {
    // `d` is the original data object for the row
    return '<table cellpadding="5" cellspacing="0" border="0" style="font-size:14px; padding-left:50px;">'+
        '<tr>'+
            '<td>More info: </td>'+
            '<td>'+d+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>More info: </td>'+
            '<td>blahblah</td>'+
        '</tr>'+
    '</table>';
}
// more option - disabled for now
$('#rtable tbody').on('click', 'td.details-control', function () {
    var tr = $(this).closest('tr');
    var row = table.row( tr );
    if ( row.child.isShown() ) {
        row.child.hide();
        tr.removeClass('shown');
    } else {
        row.child(format(row.data()[2])).show();
        tr.addClass('shown');
    }
} );
</script>
